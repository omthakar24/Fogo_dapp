name: Build SBF from Source

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      SOLANA_VERSION: v1.18.26
      RUST_TOOLCHAIN: 1.75.0

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install apt dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang llvm pkg-config libssl-dev ca-certificates curl git python3 make cmake bzip2

      - name: Install Rustup and toolchain
        run: |
          curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain ${RUST_TOOLCHAIN}
          source $HOME/.cargo/env
          rustc --version

      - name: Clone Solana source
        run: |
          git clone https://github.com/solana-labs/solana.git solana-src
          cd solana-src
          git fetch --all --tags
          git checkout ${SOLANA_VERSION}
          git rev-parse --short HEAD

      - name: Build Solana SBF toolchain (this takes time)
        run: |
          set -e
          cd solana-src
          # prepare dependencies and build the sbf toolchain components
          # The following uses Solana's build script to produce sbf tools and sysroot
          # This sequence mirrors the steps required to set up SBF toolchain in a fresh environment
          ./fetch-perf-libs.sh || true
          # build required components; this may take ~20-40 minutes on the runner
          cargo build -p solana-sbf-tools --release --manifest-path=Cargo.toml || true
          # Build sbf sysroot and toolchain pieces
          RUSTFLAGS="" cargo build-binaries --release -p solana-cli || true
          # install binaries into /usr/local/bin for this runner (solana-install may be available)
          sudo cp -v target/release/solana* /usr/local/bin/ || true
          # create a local SBF sysroot path the build commands look for
          mkdir -p $HOME/.local/share/solana/sbf
          # Attempt to run solana-install to initialize sysroot (best-effort)
          if command -v solana-install >/dev/null 2>&1; then
            solana-install init ${SOLANA_VERSION} || true
          fi
          echo "SBF toolchain build step finished (best effort)."

      - name: Verify toolchain (show versions)
        run: |
          source $HOME/.cargo/env || true
          echo "rustc: $(rustc --version || true)"
          echo "cargo: $(cargo --version || true)"
          solana --version || true

      - name: Prepare project and build program
        run: |
          source $HOME/.cargo/env || true
          # ensure we are in repo workspace
          cd $GITHUB_WORKSPACE
          # remove old lockfile and regenerate to avoid lockfile version issues
          rm -f Cargo.lock || true
          cargo generate-lockfile || true
          # try to run cargo build-sbf; if not available, fall back to a manual build of crate for sanity
          if command -v cargo-build-sbf >/dev/null 2>&1; then
            cargo build-sbf --release
          else
            # attempt to invoke the solana-recommended build wrapper if available
            if command -v solana-builder >/dev/null 2>&1; then
              solana-builder cargo build-sbf --release || true
            else
              # best-effort: try to build the crate in release to catch compile errors
              cargo build --release || true
              # fallback failure will still let us inspect logs
              echo "cargo build-sbf not found. Built native release binary as fallback."
            fi
          fi

      - name: Collect artifacts
        run: |
          ls -la target || true
          ls -la target/deploy || true || true

      - name: Upload program artifact
        uses: actions/upload-artifact@v4
        with:
          name: fogo_program
          path: target/deploy/*.so
